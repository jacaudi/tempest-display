# ---------------------------------------------------------------------------
# Caching reverse proxy for RainViewer radar tiles
# ---------------------------------------------------------------------------

proxy_cache_path /var/cache/nginx/radar
    levels=1:2
    keys_zone=radar_tiles:10m
    max_size=2g
    inactive=6h
    use_temp_path=off;

# Custom log format showing cache status and upstream cache-control TTL
log_format radar_cache
    '$time_iso8601 '
    '[$upstream_cache_status] '           # HIT | MISS | EXPIRED | STALE | BYPASS
    '"$request_method $uri" '
    '$status '
    '${body_bytes_sent}b '
    'upstream=$upstream_response_time '   # blank on HIT (no upstream needed)
    'ttl="$upstream_http_cache_control"'; # Cache-Control from RainViewer

server {
    listen 8080;
    server_name _;

    access_log /dev/stdout radar_cache;

    # Health check endpoint
    location = /health {
        access_log off;
        return 200 "ok\n";
        add_header Content-Type text/plain;
    }

    location / {
        proxy_pass https://tilecache.rainviewer.com;

        # SNI + Host header required for HTTPS upstream
        proxy_ssl_server_name on;
        proxy_set_header Host tilecache.rainviewer.com;
        proxy_set_header Accept-Encoding "";

        # Cache settings
        proxy_cache              radar_tiles;
        proxy_cache_key          $uri;
        proxy_cache_valid        200 6h;
        proxy_cache_valid        403 1h;   # RainViewer blocks zoom>7 on free tier; cache to stop hammering upstream
        proxy_cache_valid        404 1m;
        proxy_cache_valid        429 30s;
        proxy_cache_use_stale    error timeout updating
                                 http_500 http_502 http_503 http_504;
        proxy_cache_lock         on;
        proxy_cache_lock_timeout 5s;

        # Expose cache status to browser DevTools
        add_header Access-Control-Allow-Origin  "*" always;
        add_header Access-Control-Allow-Methods "GET, OPTIONS" always;
        add_header X-Cache-Status               $upstream_cache_status always;

        if ($request_method = OPTIONS) {
            add_header Access-Control-Allow-Origin  "*";
            add_header Access-Control-Allow-Methods "GET, OPTIONS";
            return 204;
        }
    }
}
